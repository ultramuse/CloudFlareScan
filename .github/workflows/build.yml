name: Build CloudFlareScan with Icon

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Initialize Go Modules (if needed)
      run: |
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰ go.mod æ–‡ä»¶
        if (Test-Path "go.mod") {
          Write-Output "âœ… go.mod æ–‡ä»¶å·²å­˜åœ¨"
          # å¦‚æœå·²æœ‰ go.modï¼Œç”Ÿæˆ go.sum
          go mod tidy
        } else {
          Write-Output "ğŸ”„ åˆ›å»º go.mod æ–‡ä»¶"
          go mod init github.com/ultramuse/CloudFlareScan
          go mod tidy
        }
      
    - name: Verify icon file exists
      run: |
        if (Test-Path "cfscan.ico") {
          Write-Output "âœ… å›¾æ ‡æ–‡ä»¶ cfscan.ico å­˜åœ¨"
        } else {
          Write-Error "âŒ å›¾æ ‡æ–‡ä»¶ cfscan.ico ä¸å­˜åœ¨"
          exit 1
        }
      
    - name: Install rsrc tool for icon embedding
      run: go install github.com/akavel/rsrc@latest
      
    - name: Generate Windows resource file
      run: |
        rsrc -arch amd64 -ico cfscan.ico -o icon.syso
        Write-Output "âœ… èµ„æºæ–‡ä»¶ icon.syso å·²ç”Ÿæˆ"
      
    - name: Build CloudFlareScan executable with icon
      run: |
        go build -o CloudFlareScan.exe CloudFlareScan
        Write-Output "âœ… ç¼–è¯‘å®Œæˆï¼Œç”Ÿæˆ CloudFlareScan.exe"
        
    - name: Verify executable
      run: |
        if (Test-Path "CloudFlareScan.exe") {
          Write-Output "âœ… å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºæˆåŠŸ"
          Get-Item CloudFlareScan.exe | Format-List Name, Length, LastWriteTime
        } else {
          Write-Error "âŒ å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºå¤±è´¥"
          exit 1
        }
        
    - name: Upload Windows Executable
      uses: actions/upload-artifact@v4
      with:
        name: CloudFlareScan-Windows-With-Icon
        path: CloudFlareScan.exe
        retention-days: 30
