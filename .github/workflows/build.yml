name: Build CloudFlareScan with Icon

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Verify icon file exists
      run: |
        if (Test-Path "cfscan.ico") {
          Write-Output "✅ 图标文件 cfscan.ico 存在"
        } else {
          Write-Error "❌ 图标文件 cfscan.ico 不存在"
          exit 1
        }
      
    - name: Install rsrc tool for icon embedding
      run: go install github.com/akavel/rsrc@latest
      
    - name: Generate Windows resource file
      run: |
        rsrc -arch amd64 -ico cfscan.ico -o icon.syso
        Write-Output "✅ 资源文件 icon.syso 已生成"
      
    - name: Build CloudFlareScan executable with icon
      run: |
        go build -o CloudFlareScan.exe CloudFlareScan
        Write-Output "✅ 编译完成，生成 CloudFlareScan.exe"
        
    - name: Verify executable
      run: |
        if (Test-Path "CloudFlareScan.exe") {
          Write-Output "✅ 可执行文件创建成功"
          Get-Item CloudFlareScan.exe | Format-List Name, Length, LastWriteTime
        } else {
          Write-Error "❌ 可执行文件创建失败"
          exit 1
        }
        
    - name: Upload Windows Executable
      uses: actions/upload-artifact@v4
      with:
        name: CloudFlareScan-Windows-With-Icon
        path: CloudFlareScan.exe
        retention-days: 30
